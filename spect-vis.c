/**
 * @file spect-vis.c
 * @author Amiy Kumar
 * @brief Shows frequency decomposition of input signal 
 * @version 0.1
 * @date 2022-02-02
 * 
 * @copyright Copyright (c) 2022
 * 
 * Audio data input format:
 * Sample-rate = 48000
 * Data type   = Little Endian Signed 16 bit integer (S16_LE)
 * Channels    = 1 (mono)
 * 
 * Frequency range is logarithmic from f=22Hz to f=10kHz
 * Amplitude is adjusted by: (1 - 10^(c)) / 0.9
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdatomic.h>
#include <errno.h>
#include <complex.h>
#include <inttypes.h>
#include <math.h>

#include "wrapsdl.h"

#define AMP_MAX ((double)(UINT16_MAX - 1))
#define PI 3.1415926535897932384626433
#define RATE 48000
#define NSAMPLES 1024
#define AVG_LAG 4.
#define DT (1. / RATE)
#define FOURIER_K (2. / NSAMPLES)

typedef union audio_T {
	int16_t amp;
	char raw[sizeof(int16_t)];
} audio_T;

enum {
	NFREQS = 700,
	FREQ_BAR_MAX = 4096,
};

static const double FREQS[NFREQS] = {
	21.734,	  21.926,   22.119,   22.314,	22.510,	  22.709,   22.909,
	23.111,	  23.314,   23.520,   23.727,	23.936,	  24.147,   24.359,
	24.574,	  24.791,   25.009,   25.229,	25.452,	  25.676,   25.902,
	26.130,	  26.360,   26.593,   26.827,	27.063,	  27.302,   27.542,
	27.785,	  28.030,   28.277,   28.526,	28.777,	  29.031,   29.286,
	29.544,	  29.805,   30.067,   30.332,	30.599,	  30.869,   31.141,
	31.415,	  31.692,   31.971,   32.253,	32.537,	  32.824,   33.113,
	33.405,	  33.699,   33.996,   34.296,	34.598,	  34.903,   35.210,
	35.520,	  35.833,   36.149,   36.467,	36.789,	  37.113,   37.440,
	37.770,	  38.102,   38.438,   38.777,	39.118,	  39.463,   39.811,
	40.161,	  40.515,   40.872,   41.232,	41.596,	  41.962,   42.332,
	42.705,	  43.081,   43.461,   43.843,	44.230,	  44.619,   45.013,
	45.409,	  45.809,   46.213,   46.620,	47.031,	  47.445,   47.863,
	48.285,	  48.710,   49.139,   49.572,	50.009,	  50.450,   50.894,
	51.342,	  51.795,   52.251,   52.711,	53.176,	  53.644,   54.117,
	54.594,	  55.075,   55.560,   56.049,	56.543,	  57.041,   57.544,
	58.051,	  58.562,   59.078,   59.599,	60.124,	  60.654,   61.188,
	61.727,	  62.271,   62.820,   63.373,	63.931,	  64.495,   65.063,
	65.636,	  66.214,   66.798,   67.386,	67.980,	  68.579,   69.183,
	69.793,	  70.408,   71.028,   71.654,	72.285,	  72.922,   73.564,
	74.212,	  74.866,   75.526,   76.191,	76.862,	  77.540,   78.223,
	78.912,	  79.607,   80.309,   81.016,	81.730,	  82.450,   83.176,
	83.909,	  84.648,   85.394,   86.147,	86.906,	  87.671,   88.444,
	89.223,	  90.009,   90.802,   91.602,	92.409,	  93.223,   94.044,
	94.873,	  95.709,   96.552,   97.403,	98.261,	  99.127,   100.000,
	100.881,  101.770,  102.666,  103.571,	104.483,  105.404,  106.333,
	107.269,  108.215,  109.168,  110.130,	111.100,  112.079,  113.066,
	114.062,  115.067,  116.081,  117.104,	118.136,  119.176,  120.226,
	121.286,  122.354,  123.432,  124.520,	125.617,  126.723,  127.840,
	128.966,  130.103,  131.249,  132.405,	133.572,  134.748,  135.936,
	137.133,  138.341,  139.560,  140.790,	142.030,  143.282,  144.544,
	145.817,  147.102,  148.398,  149.706,	151.025,  152.355,  153.697,
	155.052,  156.418,  157.796,  159.186,	160.588,  162.003,  163.431,
	164.870,  166.323,  167.788,  169.267,	170.758,  172.262,  173.780,
	175.311,  176.856,  178.414,  179.986,	181.571,  183.171,  184.785,
	186.413,  188.055,  189.712,  191.384,	193.070,  194.771,  196.487,
	198.218,  199.964,  201.726,  203.503,	205.296,  207.105,  208.930,
	210.770,  212.627,  214.501,  216.390,	218.297,  220.220,  222.160,
	224.118,  226.092,  228.084,  230.094,	232.121,  234.166,  236.229,
	238.310,  240.410,  242.528,  244.665,	246.820,  248.995,  251.189,
	253.402,  255.634,  257.886,  260.159,	262.451,  264.763,  267.096,
	269.449,  271.823,  274.218,  276.633,	279.071,  281.529,  284.010,
	286.512,  289.036,  291.583,  294.152,	296.743,  299.358,  301.995,
	304.656,  307.340,  310.048,  312.779,	315.535,  318.315,  321.119,
	323.949,  326.803,  329.682,  332.587,	335.517,  338.473,  341.455,
	344.463,  347.498,  350.560,  353.648,	356.764,  359.907,  363.078,
	366.277,  369.504,  372.759,  376.044,	379.357,  382.699,  386.071,
	389.472,  392.903,  396.365,  399.857,	403.380,  406.934,  410.519,
	414.136,  417.785,  421.465,  425.179,	428.925,  432.704,  436.516,
	440.362,  444.241,  448.155,  452.104,	456.087,  460.105,  464.159,
	468.248,  472.374,  476.535,  480.734,	484.969,  489.242,  493.552,
	497.901,  502.288,  506.713,  511.177,	515.681,  520.224,  524.807,
	529.431,  534.096,  538.801,  543.548,	548.337,  553.168,  558.042,
	562.958,  567.918,  572.922,  577.969,	583.061,  588.198,  593.381,
	598.608,  603.882,  609.203,  614.570,	619.985,  625.447,  630.957,
	636.516,  642.124,  647.782,  653.489,	659.246,  665.054,  670.914,
	676.825,  682.788,  688.803,  694.872,	700.994,  707.170,  713.400,
	719.686,  726.026,  732.423,  738.876,	745.386,  751.953,  758.578,
	765.261,  772.003,  778.805,  785.666,	792.588,  799.571,  806.616,
	813.722,  820.891,  828.124,  835.420,	842.780,  850.205,  857.696,
	865.252,  872.876,  880.566,  888.324,	896.151,  904.046,  912.011,
	920.046,  928.152,  936.329,  944.579,	952.901,  961.296,  969.765,
	978.309,  986.929,  995.624,  1004.396, 1013.245, 1022.172, 1031.177,
	1040.262, 1049.427, 1058.673, 1068.000, 1077.410, 1086.902, 1096.478,
	1106.139, 1115.884, 1125.715, 1135.633, 1145.639, 1155.732, 1165.914,
	1176.187, 1186.549, 1197.003, 1207.549, 1218.188, 1228.921, 1239.748,
	1250.670, 1261.689, 1272.805, 1284.019, 1295.332, 1306.744, 1318.257,
	1329.871, 1341.588, 1353.407, 1365.331, 1377.360, 1389.495, 1401.737,
	1414.087, 1426.546, 1439.114, 1451.793, 1464.584, 1477.487, 1490.505,
	1503.636, 1516.884, 1530.248, 1543.730, 1557.331, 1571.052, 1584.893,
	1598.857, 1612.943, 1627.154, 1641.489, 1655.952, 1670.541, 1685.259,
	1700.107, 1715.085, 1730.196, 1745.439, 1760.817, 1776.331, 1791.981,
	1807.769, 1823.696, 1839.763, 1855.972, 1872.324, 1888.820, 1905.461,
	1922.248, 1939.184, 1956.269, 1973.504, 1990.892, 2008.432, 2026.127,
	2043.978, 2061.986, 2080.153, 2098.480, 2116.968, 2135.619, 2154.435,
	2173.416, 2192.565, 2211.882, 2231.369, 2251.028, 2270.861, 2290.868,
	2311.051, 2331.412, 2351.953, 2372.674, 2393.578, 2414.666, 2435.940,
	2457.402, 2479.052, 2500.894, 2522.927, 2545.155, 2567.579, 2590.200,
	2613.021, 2636.042, 2659.267, 2682.696, 2706.331, 2730.175, 2754.229,
	2778.494, 2802.974, 2827.669, 2852.582, 2877.714, 2903.068, 2928.645,
	2954.447, 2980.477, 3006.736, 3033.226, 3059.950, 3086.909, 3114.106,
	3141.542, 3169.220, 3197.142, 3225.310, 3253.726, 3282.392, 3311.311,
	3340.485, 3369.916, 3399.606, 3429.558, 3459.773, 3490.255, 3521.005,
	3552.026, 3583.321, 3614.891, 3646.740, 3678.869, 3711.281, 3743.978,
	3776.964, 3810.240, 3843.810, 3877.675, 3911.839, 3946.303, 3981.072,
	4016.146, 4051.530, 4087.225, 4123.235, 4159.562, 4196.209, 4233.179,
	4270.475, 4308.099, 4346.055, 4384.345, 4422.973, 4461.941, 4501.252,
	4540.910, 4580.917, 4621.276, 4661.991, 4703.065, 4744.500, 4786.301,
	4828.470, 4871.010, 4913.926, 4957.219, 5000.894, 5044.953, 5089.401,
	5134.240, 5179.475, 5225.108, 5271.143, 5317.583, 5364.433, 5411.695,
	5459.374, 5507.473, 5555.996, 5604.946, 5654.327, 5704.144, 5754.399,
	5805.098, 5856.242, 5907.838, 5959.888, 6012.397, 6065.368, 6118.806,
	6172.715, 6227.098, 6281.961, 6337.307, 6393.141, 6449.467, 6506.289,
	6563.611, 6621.439, 6679.776, 6738.627, 6797.997, 6857.889, 6918.310,
	6979.262, 7040.752, 7102.783, 7165.361, 7228.491, 7292.176, 7356.423,
	7421.235, 7486.619, 7552.578, 7619.119, 7686.246, 7753.965, 7822.280,
	7891.196, 7960.721, 8030.857, 8101.612, 8172.990, 8244.997, 8317.638,
	8390.919, 8464.846, 8539.424, 8614.659, 8690.557, 8767.124, 8844.365,
	8922.287, 9000.895, 9080.196, 9160.196, 9240.900, 9322.316, 9404.449,
	9487.305, 9570.891, 9655.214, 9740.280, 9826.095, 9912.666, 10000.000,
};

/* Global variables */
static double freq_avgs_g[NFREQS];
static atomic_int_least32_t freq_bar_g[NFREQS];
static char *ain_fpath = "-";

static inline double audio_freqs_cal(audio_T ains[static NSAMPLES], double f,
				     double t)
{
	double complex c = 0.;

	for (int i = 0; i < NSAMPLES; i++) {
		c += cexp(-I * 2 * PI * f * t) *
		     ((double)ains[i].amp / AMP_MAX);
		t += DT;
	}

	c *= FOURIER_K;
	/* (1 - 10^(-x)) * 1.111 => log scaling, (1 / 0.9 == 1.111.....) */
	/* Keeps in (full)range [0, 1) */
	return (1 - pow(10., -cabs(c))) * 1.111;
}

int fourier_threaded(void *arg)
{
	state_T *state = (state_T *)arg;
	FILE *ain_pipe = NULL;
	if (strcmp("-", ain_fpath) == 0)
		ain_pipe = stdin;
	else if ((ain_pipe = fopen(ain_fpath, "rb")) == NULL) {
		perror("Error opening file");
		state->quit = 1;
		return 1;
	}

	audio_T ains[NSAMPLES] = { 0 };
	double t = 0.;

	while (!state->quit) {
		fread(ains, sizeof(audio_T), NSAMPLES, ain_pipe);

		/* Function generator use if needed */
		// double tt = 0.;
		// for (int i = 0; i < NSAMPLES; i++) {
		// 	ains[i].amp = AMP_MAX * sin(2 * M_PI * 5000. * tt);
		// 	tt += DT;
		// }

		for (int i = 0; i < NFREQS; i++) {
			/* Averaage for smoothing */
			double tmp = audio_freqs_cal(ains, FREQS[i], t);
			tmp = freq_avgs_g[i] * (AVG_LAG - 1.) / AVG_LAG +
			      tmp / AVG_LAG;
			freq_avgs_g[i] = tmp;
			freq_bar_g[i] = freq_avgs_g[i] * FREQ_BAR_MAX;
		}

		t += DT * NSAMPLES;
	}

	if (ain_pipe != stdin)
		fclose(ain_pipe);

	return 0;
}

static inline rgb_T colmap_hot(uint8_t x)
{
	rgb_T ret = { 0 };

	if (x <= UINT8_MAX / 3) {
		ret.r = x * 3;
	} else if (UINT8_MAX / 3 < x && x <= 2 * UINT8_MAX / 3) {
		ret.r = UINT8_MAX;
		ret.g = 3 * (x - UINT8_MAX / 3);
	} else if (2 * UINT8_MAX / 3 < x) {
		ret.r = UINT8_MAX;
		ret.g = UINT8_MAX;
		ret.b = 3 * (x - 2 * UINT8_MAX / 3);
	}

	return ret;
}

int main(int argc, char *argv[static argc + 1])
{
	if (argc >= 2)
		ain_fpath = argv[1];

	state_T s = {
		.resx = 1500,
		.resy = 900,
		.title = "Spectrum Vizz",
		.win_flags = SDL_WINDOW_SHOWN | SDL_WINDOW_RESIZABLE,
		.ren_flags = SDL_RENDERER_ACCELERATED |
			     SDL_RENDERER_PRESENTVSYNC,
	};
	int err = state_create(&s);
	if (err)
		goto init_err;

	SDL_Thread *aud_thr =
		SDL_CreateThread(fourier_threaded, "fourier_threaded", &s);
	if (aud_thr == NULL)
		goto thr_err;

	int lineY = 0;

	while (!s.quit) {
		handle_events(&s);
		if (s.error)
			goto late_err;

		/* Draw the history on a texture, to keep it recorded */
		SDL_SetRenderTarget(s.ren, s.rentex);

		for (int i = 0; i < NFREQS; i++) {
			rgb_T col = colmap_hot(
				(uint8_t)(255 * freq_bar_g[i] / FREQ_BAR_MAX));
			SDL_SetRenderDrawColor(s.ren, col.r, col.g, col.b, 255);
			SDL_RenderDrawPoint(s.ren, i, lineY);
		}

		SDL_SetRenderTarget(s.ren, NULL);
		SDL_RenderCopy(s.ren, s.rentex, NULL, NULL);

		/* Draw the histogram */
		for (int i = 0; i < NFREQS; i++) {
			int y = s.resy * freq_bar_g[i] / FREQ_BAR_MAX;
			SDL_SetRenderDrawColor(s.ren, 255, 0, 0, 255);
			SDL_RenderDrawLine(s.ren, NFREQS + i, s.resy - y,
					   NFREQS + i, s.resy);
		}

		/* Green bars */
		SDL_SetRenderDrawColor(s.ren, 0, 255, 0, 255);
		for (int i = 0; i <= 2 * NFREQS; i += NFREQS)
			SDL_RenderDrawLine(s.ren, i, 0, i, s.resy);

		/* Cyan scan line */
		SDL_SetRenderDrawColor(s.ren, 0, 255, 255, 255);
		SDL_RenderDrawLine(s.ren, 0, lineY, NFREQS, lineY);

		SDL_RenderPresent(s.ren);
		SDL_SetRenderDrawColor(s.ren, 0, 0, 0, 0);
		SDL_RenderClear(s.ren);

		lineY = (lineY + 1) % s.resy;
	}

	int aud_thr_ret = 0;
	SDL_WaitThread(aud_thr, &aud_thr_ret);
	if (aud_thr_ret != 0)
		goto late_err;

	state_destroy(&s);

	return 0;

late_err:
thr_err:
	state_destroy(&s);
init_err:
	printf("ERROR!!1\n");
	return EXIT_FAILURE;
}
